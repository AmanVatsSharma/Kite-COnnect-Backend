<!DOCTYPE html>
<html>
<head>
    <title>Simple WSS Test</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .connected { background: #4CAF50; color: white; }
        .error { background: #f44336; color: white; }
        .connecting { background: #ff9800; color: white; }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 400px;
        }
    </style>
</head>
<body>
    <h1>üîå Simple WebSocket Secure (WSS) Test</h1>
    
    <div>
        <label>Server URL:</label><br>
        <input type="text" id="serverUrl" value="https://marketdata.vedpragya.com" />
    </div>
    
    <div>
        <label>API Key:</label><br>
        <input type="text" id="apiKey" value="demo-key-1" />
    </div>
    
    <button onclick="testConnection()">Connect & Test</button>
    <button onclick="clearLog()">Clear Log</button>
    
    <div id="status" class="status">Ready to connect...</div>
    
    <div class="log" id="log"></div>
    
    <script>
        let socket = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function updateStatus(status, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status ' + status;
            statusDiv.textContent = message;
        }
        
        function testConnection() {
            const serverUrl = document.getElementById('serverUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            
            if (!apiKey) {
                alert('Please enter an API key');
                return;
            }
            
            const wsUrl = serverUrl;
            log(`üîç Starting connection to: ${wsUrl}`);
            log(`üîë Using API Key: ${apiKey.substring(0, 8)}...`);
            updateStatus('connecting', 'Connecting...');
            
            // Close existing connection if any
            if (socket) {
                socket.disconnect();
            }
            
            try {
                log('üîç Attempting connection with Socket.IO...');
                
                // CORRECT: NestJS Socket.IO with namespace
                // With namespace: '/market-data', the URL is: base/market-data
                const socketUrl = wsUrl + '/market-data';
                log('üîó Full Socket.IO URL: ' + socketUrl);
                log('üìã This connects to the /market-data namespace');
                log('üîë API Key being sent: ' + apiKey.substring(0, 8) + '...');
                
                // Connect to the namespace directly
                // Query parameter is MOST RELIABLE for Socket.IO WebSocket
                socket = io(socketUrl, {
                    query: {
                        'api_key': apiKey  // Query parameter works best
                    },
                    transports: ['websocket', 'polling'],
                    reconnection: false,
                    autoConnect: true,
                    forceNew: true
                });
                
                // Connection event
                socket.on('connect', () => {
                    log('‚úÖ CONNECTED! Socket ID: ' + socket.id);
                    updateStatus('connected', '‚úÖ Connected!');
                    
                    // IMPORTANT: Get auth token from server response first
                    log('üì• Waiting for server authentication...');
                });
                
                // Server sends connection confirmation with auth info
                socket.on('connected', (data) => {
                    log('üì• Server connected event: ' + JSON.stringify(data));
                    
                    // Wait a moment then subscribe
                    setTimeout(() => {
                        log('üì§ Sending test subscription...');
                        socket.emit('subscribe', {
                            instruments: [26000], // Nifty
                            mode: 'ltp'
                        });
                    }, 1000);
                });
                
                // Subscription confirmation
                socket.on('subscription_confirmed', (data) => {
                    log('‚úÖ Subscription confirmed: ' + JSON.stringify(data));
                });
                
                // Market data
                socket.on('market_data', (data) => {
                    log('üí∞ Market data: ' + JSON.stringify(data));
                });
                
                // Connection error - detailed logging
                socket.on('connect_error', (error) => {
                    log('‚ùå Connection error: ' + JSON.stringify(error));
                    log('‚ùå Error details: type=' + error.type + ', message=' + error.message);
                    console.error('Full error object:', error);
                    updateStatus('error', '‚ùå Connection failed: ' + (error.message || error.type));
                });
                
                // Error
                socket.on('error', (error) => {
                    log('‚ùå Error event: ' + JSON.stringify(error));
                    updateStatus('error', '‚ùå Error: ' + error.message);
                });
                
                // Disconnect
                socket.on('disconnect', (reason) => {
                    log('‚ö†Ô∏è Disconnected: ' + reason);
                    updateStatus('error', 'Disconnected: ' + reason);
                });
                
            } catch (error) {
                log('‚ùå Exception: ' + error.message);
                updateStatus('error', 'Exception: ' + error.message);
            }
        }
        
        // Auto-test on load
        window.onload = function() {
            log('üöÄ WSS Test Page Loaded');
            log('üìù Instructions:');
            log('  1. Make sure server URL is https://marketdata.vedpragya.com');
            log('  2. Enter your API key (demo-key-1)');
            log('  3. Click "Connect & Test"');
            log('  4. Check browser console (F12) for detailed logs');
        };
    </script>
</body>
</html>

